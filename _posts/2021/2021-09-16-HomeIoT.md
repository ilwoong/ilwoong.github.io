---
layout: post
title: Home IoT 구축기
tags: [IoT, SmartThings, Home Assistant]
author: ilwoong
---

2021년 1월부터 관심을 가지고 시작했던 Home IoT 구축은, 세계적인 반도체 수급 문제로 구하려고 했던 기기들을 구입할 수 없어서 2021년 9월이 되어서야 마무리하게 되었습니다. 관련 사진을 인스타그램에 올렸더니, 어떻게 구축했는지 궁금해하는 분이 있어 잊어버리기 전에 기록으로 남겨보고자 합니다. github pages에 사진을 올리는 것이 조금 귀찮아서 글로만 적는 것은 양해해 주시기 바랍니다.

### 네트워크 구축

현재 구축되어 있는 장비들이 어떻게 연결되어있는지를 그려보면 다음과 같습니다. 메인 기기들은 모두 Zigbee 네트워크에 물려있고, Zigbee 통신을 지원하지 않는 몇몇 기기들을 WiFi로 물려놓았습니다. 그리고 지금 새로 구축하려고 하면 후보에 안넣을 것 같은 Z-wave 기기는 예전에 LG 유플러스 IoT 서비스를 멋모르고 가입했다가 버려뒀던 플러그들이 아까워서 추가해봤습니다.

![네트워크 맵](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/ilwoong/ilwoong.github.io/master/plantuml/network-map.pu)

### 플랫폼 선정

Home IoT를 구축하기 위해서 가장 먼저 해야 할 것은 메인이 되는 플랫폼을 선정하는 일입니다. 처음에 별 생각없이 아무 허브나 구매했다가는 중복 지출을 피할 수 없습니다. 특정 IoT 기기 개발사에서 제작하여 판매하는 Zigbee 허브는 추천하지 않습니다. 보통 자사 기기들만 지원하고 타사 기기는 사용할 수 없어서 다양한 기기들을 연계한 서비스를 만들어낼 수 없기 때문입니다. 추천할만한 플랫폼은 스마트싱스와 홈어시스턴트 입니다.  아래 두 카페에 가면 많은 정보를 얻을 수 있습니다.

- [SmartThings & IoT Home](https://cafe.naver.com/stsmarthome){:target="_blank"}
- [홈어시스턴트 한국 사용자모임](https://cafe.naver.com/koreassistant){:target="_blank"}

저는 메인 플랫폼으로 스마트싱스를, 보조 플랫폼으로 홈 어시스턴트를 사용하고 있습니다.
- 스마트싱스는 다양한 기기들을 연동해서 비교적 쉽게 사용할 수 있게 해주는 플랫폼입니다. 스마트싱스 허브는 Zigbee와 Z-wave 통신기능을 포함하고 있어 별도 동글을 구매할 필요가 없습니다. Zigbee 통신의 주파수는 세계 공통이지만, Z-wave의 경우는 지역별로 주파수가 다르기 때문에, 해외에서 구매한 허브에 국내에서 판매되는 Z-wave 장치를 연결할 수 없습니다. 그러나 최근 국내에는 Z-wave 장치들이 거의 판매되지 않고 있어 별 문제가 되지는 않을 것 같습니다.
- 홈 어시스턴트는 오픈소스로 관리되는 프로젝트로, 별도의 서버 혹은 docker를 동작시킬 수 있는 NAS가 필요합니다. 또한 Zigbee 및 Z-wave 네트워크 구축을 위해 별도의 동글도 구매해야 하는 번거로움이 있습니다. 사용자 편의성은 스마트싱스에 비해 떨어져서 처음 접하는 사람들은 매우 어려움을 겪을 가능성이 높지만, 서버 개발 혹은 관리의 경험이 있는 사람들에게넌 자신의 입맛대로 거의 모든 것을 커스터마이징 할 수 있는 장점이 있습니다.

### 사용중인 기기들

#### 허브

- <b>aeotec 스마트싱스 허브</b>: 국내에서 스마트싱스 허브를 구하기 힘들 때, 독일 아마존에서 구매한 스마트싱스 허브입니다. 국내회사인 삼진에서 제작하여 aeotec에 납품한 것으로 기존 스마트싱스 허브 v3과 로고만 다를 뿐 같은 제품입니다. 단 유럽에서 사용되는 모델이기 때문에 Z-wave 기기를 유럽향만 사용해야 한다는 단점이 있습니다.
- <b>라즈베리파이4 4G</b>: 홈 어시스턴트 서버를 운영하기 위해 사용하고 있습니다. 국내 버전의 Z-wave 플러그를 3개 가지고 있어서 usb에 Z-wave 동글을 설치하였습니다. 홈 어시트턴트 서버, MQTT 서버, Z-wave 서버 등이 동시에 도커 컨테이너를 이용하여 동작하고 있습니다.

#### 조명 기기

- <b>다원 Zigbee 스위치</b>: LED등을 제어하기 위해 스마트 스위치를 설치하였습니다. 별도의 중성선 시공이 필요없는 2선식을 선택하였으며, 버튼 크기가 커서 조작하기 용이해 보이는 다원 DNS의 스마트 스위치를 선택했습니다. 2선식의 특성상 전력 소모가 낮은 전등에 설치하는 경우에는 잔광이 생기거나 깜빡거릴 수 있는데, 동봉된 컨덴서를 이용하면 해결이 됩니다.
- <b>SONOFF ZBMini</b>: 집에 딱 하나 3선식으로 사용할 수 있는 전구가 하나 있는데, 스위치가 아주 낮은 곳에 설치되어 있어 거의 안쓰고 있었습니다만, SONOFF ZBMINI를 사용해서 다른 Zigbee 버튼으로 제어할 수 있게 해서 지금은 잘 쓰고 있습니다.
- 화장실 조명같은 경우 환풍기가 연결되는데, 그럴 일은 별로 없다고는 하지만 혹시나 환풍기가 외부 바람에 의해 반대방향으로 도는 경우, 역전류가 스위치에 흘러서 스마트 스위치가 고장날 수도 있다고 합니다. (2선식 스위치인 경우, 3선식은 상관없음) 저희 집은 2선식이기 때문에 혹시 몰라서 화장실 조명 스위치는 스마트 스위치를 적용하지 않았습니다.

#### 스마트 플러그

- <b>다원 WiFi 플러그</b>: 예전에 구글 홈을 구매했을때 1개 사은품으로 받은 것을 시작으로 필요할 때마다 하나씩 추가하다보니 어느덧 8개가 되었습니다. 다른 플러그들과는 달리 옆 플러그와 간섭이 거의 없는 외관을 가지고 있어 사용성이 좋습니다. 원래는 다원 AIPM 앱에 연동하고 스마트싱스와는 C2C로 연계해서 사용하고 있었으나, 9월 다원 서버 먹통 사태 이후 불안해서 직접 MQTT 서버를 설치하고 Home Assistant에 연동되도록 바꿔서 사용중입니다.
- <b>다원 WiFi 멀티탭</b>: 4구 멀티탭으로 각 전원을 별개로 제어할 수 있을것이라는 기대를 가지고 구매했으나, 4구가 한꺼번에 on/off 되도록만 동작하는 멀티탭입니다. 저는 PC에 연결해서 모니터와 USB 허브 등의 전원을 동시에 관리하는 용도로 사용하고 있습니다. 멀티탭 역시 서버 먹통 사태 이후 Home Assistant를 이용하여 로컬화해서 사용중입니다.
- <b>다원 Zigbee 플러그</b>: 1월부터 구매하고 싶었으나, 반도체 대란으로 인해 수급이 안되다가 최근 판매를 재개한 플러그입니다. 전력 사용량 변화를 즉각 레포트할 수 있기 때문에 전력을 트리거로한 자동화를 만들기에 좋습니다. WiFi 플러그와 마찬가지로 옆 플러그와 간섭이 거의 없는 장점이 있습니다.
- <b>이지세이버 Z-wave 플러그</b>: 예전에 LGU+ 인터넷 사용할때 결합하면 할인해준다고 신청했었던 IoT 서비스에 포함되어 있었던 플러그입니다. 한동안 온오프 버튼이 있는 플러그로만 사용하고 있다가 현재는 홈어시스턴트에 연결해서 사용하고 있습니다.

#### AI 스피커

- <b>구글 홈</b>: 예전에 사두었던 구글 홈을 주방에 놓고 메인 스피커로 사용하고 있습니다. 구글 홈 미니보다는 사운드가 낫지만 그렇게 많이 좋지는 않으니 사운드를 생각한다면 구글 네스트 오디오를, 음성 명령 기기로만 생각한다면 구글 홈 미니가 낫습니다.
- <b>구글 홈 미니</b>: 구글 홈 미니를 방마다 추가해서 어디서나 음성으로 명령을 호출할 수 있게 했습니다. 최신 버전인 구글 네스트 미니의 경우 마이크가 3개(홈 미니의 경우 2개)라서 음성 인식을 더 잘한다는 설명이 있는데, 사용기들을 읽어보면 별 차이가 없다고 합니다. 그런데 네스트 미니가 홈 미니보다 거의 2배 가량 비싸서 가성비가 떨어집니다. 당근 마켓에서 중고로 나오는 홈 미니를 노려보는 것도 괜찮을 것 같습니다.
- <b>JBL Link Music</b>: 사운드가 좋을것 같아서 삼성 홈페이지에서 할인할때 산 구글 어시스턴트 스피커입니다. 사운드가 구글 홈보다 좋긴 한데, 다른 구글 스피커들끼리는 가까운 스피커가 잘 대답하는데 이 스피커가 껴있으면, 가까운 스피커 인식이 잘 안되는 것 같습니다.

#### 도어락

- <b>SHP-DP960</b>: 도어락은 삼성SDS의 SHP-DP960 모델을 사용하고 있습니다. 지문인식으로 문을 열 수 있는 푸시풀 형태의 도어락입니다. 이 모델은 기본적으로 WiFi 모듈이 달려있는데, 스마트싱즈와 C2C로 연동이 되긴 하지만, 배터리 정보밖에 트리거로 쓸 수 있는 정보가 없어서 별로 의미는 없습니다. 와이파이 모듈을 제거하고 Zigbee 모듈을 사서 스마트싱스에 연결하면 문열림을 트리거로 사용할 수 있다고 하는데, 그러면 삼성 스마트홈 어플에서 제공하는 게스트를 위한 임시 비밀번호라던가, 누구 지문으로 열렸는지 등에 대한 기능은 사용할 수 없다고 해서 그냥 C2C로 연동만 해두고 말았습니다.

#### 가스락

- <b>다원 가스락</b>: 가스불을 가장 약하게 두고 깜빡하고 자고 일어났다가, 주방에서 열기가 느껴져서 깜짝 놀라 가스 불을 끈 적이 있습니다. 가장 약한 상태에서는 불꽃이 안보이는 가스레인지여서 불이 켜있는 줄 몰랐습니다. 가스밸브 타이머를 찾아보다 IoT 가스락이 있길래 구매해보았습니다. 국내 법규상 수도나 가스 밸브류는 원격에서 잠글 수는 있지만, 열 수 있도록 만들 수는 없다고 합니다. 타이머 설정해놓고 시간이 되면 자동으로 잠기기 때문에 IoT 기능을 쓸 일이 없다고 생각하고 있었습니다. 다만 가스가 열리는 경우를 트리거로 설정해서 다른 작업을 할 수 있어서 지금은 가스 밸브가 열렸는데 주방 조명이 꺼져 있으면 주방 조명을 켜는 자동화 조건을 추가하여 사용하고 있습니다. 스마트싱스에 바로 사용할수는 없으며, DTH 수정이 필요합니다.

#### 동작감지 센서

- <b>스마트싱스용 동작감지센서</b>: 그냥 동작감지센서가 써보고 싶어 추가한 기기입니다. 크기도 작고 동작 감지도 잘 되서 현재는 현관 문 앞에 두고, 일몰시간대에 조명이 모두 꺼져 있는 경우 움직임이 감지되면 현관 조명을 켜는 용도로 사용하고 있습니다.

#### 단축 버튼

- <b>스마트싱스용 스마트버튼</b>: 정식 지원 제품이다보니 마감도 좋고, 클릭감도 준수합니다. 클릭, 롱클릭, 더블클릭의 세 가지 동작을 지원합니다. 온도 센서가 달려있어 배터리 소모가 빨리 된다고 하는 단점이 있다고는 합니다. 막상 받아보면 버튼 크기에 비해 가격이 비싼 감이 있습니다.
- <b>Aqara T1 미니 버튼(WXKG13LM)</b>: 스마트싱스용 스마트버튼보단 저렴하고, 크기도 작고, 디자인도 준수하며, zigbee 3.0을 지원한다고 해서 구매해본 버튼인데, zigbee 표준을 따르지 않아서인지 재대로 동작하지 않아서 스마트싱스용 스마트버튼의 DTH(Device Type Handler) 소스코드를 참고해서 DTH를 새로 구현해야 했습니다. 그나마도 표준과는 살짝 다른 방식으로 동작하는지, 원래 클릭, 롱클릭, 더블클릭의 3가지 동작을 지원한다고 하는데, 클릭과 롱클릭을 구별하는데는 실패했습니다. 제가 구현한 DTH는 [github](https://github.com/sugarkub/SmartThingsDevices){:target="_blank"}에 공개되어 있습니다.
- <b>Aqara T1 버튼 1구 및 2구(WXKG04LM)</b>: 버튼의 크기가 크고 디자인이 마음에 들어서 구매해본 버튼입니다. DTH를 수정하면 다는 아니어도 사용할 수 있겠지라고 생각했지만 오산이었습니다. 스마트싱스에서 사용하기에는 적합하지 않습니다. [참고글](https://cafe.naver.com/stsmarthome/41702){:target="_blank"}
- <b>샤오미 Aqara 미니 버튼(WXKG11LM)</b>: 알리익스프레스에서 구입할 수 있는 Aqara 미니 버튼입니다. zigbee 통신을 사용하며 스마트싱스용 [DTH](https://github.com/orangebucket/Anidea-for-SmartThings){:target="_blank"}를 사용하여 모든 동작을 이용할 수 있습니다. 스마트싱스에서 사용하기는 이 버튼이 T1 버튼보다 좋습니다.
- <b>Zemismart 4구 버튼</b>: 알리익스프레스에서 구매한 4구 버튼입니다. 제 기준으로 더 마음에 드는 외형을 가진 구형 버튼이 있고, 좀 더 마음에 들지 않는 신형 버튼이 있는데, 저는 두개 모두 다 구매해서 사용하고 있습니다. 주의할 점은 생긴건 똑같이 생겼는데 스마트싱스에 연결할 수 없는 제품도 있다는 점입니다. 반드시 스마트싱스에서 사용할 수 있다는 상품 소개글이나 판매자 말을 확인하고 사야 합니다.


#### 기타

- <b>타임랙</b>: 네트워크에 연결되는 제품은 아니지만, 화장실 환풍기 스위치에 설치하였습니다. 이 제품은 스위치가 꺼지면, 스위치에 연결된 전기 기구가 바로 꺼지는 것이 아니라, 제품의 스펙에 표시된 시간 후에 꺼지도록 하는 제품입니다. 1분, 5분, 10분짜리를 판매하는데 저는 10분짜리를 환풍기에 설치하였습니다.

### 자동화 예시

#### 조명

- <b>웰컴 라이트</b>: 현관에 모션 센서를 설치해두고, 일몰 시간대(스마트싱스에서 지원함)에 집 안의 다른 조명들이 꺼져 있는 경우에 움직임이 감지되면 현관 조명을 켭니다. 움직임이 없어지면 1분 후에 자동으로 현관 조명을 끕니다.
- <b>주방</b>: 주방 한구석에 있는 조명 버튼을 누르러 가기 귀찮아 조명 없이 요리하는 경우가 있었습니다. 단축 버튼에 주방 조명을 설정하고 조리대에 단축 버튼을 두어 조명 접근성을 높였습니다.
- <b>가스락</b>: 가스 밸브가 열림 상태로 변경되었는데 주방의 조명이 꺼져있으면, 주방의 조명을 켜도록 설정해두었습니다.
- <b>침실</b>: 침대 머리맡에 조명을 연결한 단축 버튼을 두어 누워서도 조명을 끌 수 있게 하였습니다.
- <b>드라이어</b>: 드라이어에 zigbee 방식의 스마트 플러그를 설치하여 일정 수준 이상의 전력 사용이 감지되면 드라이어를 사용하는 것으로 판단하고, 드라이어가 있는 파우더룸의 조명을 켜도록 설정하였습니다. 머리를 말리고 조명을 끄는 것을 잊어버리는 경우가 많아 파우더룸의 조명은 켜진 뒤 10분 후에 자동으로 꺼지게 설정하였습니다.
- <b>베란다</b>: 밤에 베란다 나가면서 조명 켜는 것을 항상 잊어버리기 때문에, 베란다 조명 스위치를 제어하도록 설정한 단축 버튼을 거실의 베란다 나가는 쪽에 두어 어두운 곳에서 물건을 찾지 않아도 되게 하였습니다.

#### 절전

- <b>PC 절전</b>: 바이오스에서 AC 전원이 인가되면 전원을 켜도록 설정해두고, PC 앞에 놓아둔 단축 버튼을 더블 클릭하면 멀티탭의 전원이 켜지게 하면 PC 전원을 켤 수 있습니다. 해당 멀티탭이 사용하는 전력이 일정 수준(예. 20W 이하)로 떨어지면 멀티탭의 전원을 차단하여 대기 전력으로 낭비되는 전기를 절약할 수 있습니다.
- <b>전기 장판</b>: 스마트 플러그를 설치하고, 스마트 플러그에서 측정하는 전력 사용량이 일정 수준 이하를 일정 기간동안 유지하는 경우(예. 한시간 동안 20W 이하 소모), 전원을 차단하여 혹시 모를 화재 위험을 줄이고 낭비되는 전기를 절약할 수 있습니다.

### 맺음말

- 전기 작업을 할 때는 안전을 위해 반드시 두꺼비집에서 해당 라인을 차단하고, 스위치를 여러 번 껐다 켰다 해서 잔여 전류가 있지는 않은지 확인 후에 작업해야 합니다.
- 스마트 스위치 설치는 기본적으로는 일자/십자 드라이버만 있으면 됩니다. 그러나 헤드 랜턴, 검전기, 니퍼 등이 있으면 더욱 편리합니다. 전동 드라이버를 사용하는 경우 토크 조절이 되서 나사 머리를 망가뜨리지 않는 것을 사용하는 것이 좋습니다. (나사머리 많이 망가뜨려봤습니다.)
- 처음에는 음성 명령으로만 제어해도 충분하다고 생각했습니다. 그러나 종종 오인식이 나기도 하고, 당장 조명을 켜고 싶은데 명령을 내리는 5 ~ 10초 정도의 시간을 기다리기 힘들 때가 있었습니다. 그래서 집안 곳곳에 조명을 제어할 수 있는 버튼을 두어 조명 제어를 쉽게 하도록 했습니다.
- 다원DNS 제품을 많이 사용했는데, 이 회사 제품은 하드웨어는 훌륭하지만, 소프트웨어(특히 서버)가 많이 불안정합니다. 아마 앞으로는 다원의 제품을 구매하더라도 다원 서버를 사용할 필요가 없는 zigbee 제품들만 구매하게 될 것 같습니다. 그나마 다행인건 다원의 최근 제품들은 WWST(Works with SmartThings) 인증을 받고 있어서 스마트싱스에서 사용하기 용이합니다.
- 알리익스프레스에서 구매하고자 하는 제품들은 카페 등을 통해서 스마트싱스나 홈 어시스턴트에서 잘 동작하는지 확인해보고 구매할 필요가 있습니다.
- 기기만 사서 설치한다고 집이 스마트해지는 것은 아닙니다. 가족 구성원들의 생활 패턴에 맞게 자동화를 잘 구성하는 것이 중요합니다. (막상 하려고 하면 귀찮기도합니다.)